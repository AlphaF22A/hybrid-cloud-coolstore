#!/bin/bash

TMPDIR=/tmp/consolebanners

cd `dirname $0`
BASE=`pwd`
cd - >> /dev/null

source ${BASE}/../config.sh

# setup kubeconfig files for each cluster
rm -rf $TMPDIR
mkdir -p $TMPDIR
for clustername in ${CLUSTER_NAMES[@]}; do
  config="$(oc get -n $clustername secrets -l hive.openshift.io/secret-type=kubeconfig -o jsonpath='{.items[0].data.kubeconfig}' 2>/dev/null)"
  if [ -z "$config" ]; then
    echo "could not retrieve kubeconfig for $clustername"
    exit 1
  fi
  echo -n "$config" | base64 -d > ${TMPDIR}/${clustername}
done


function apply_banner {
  local bannertext="$1"
  local clustername="$2"
  local cmd="oc --insecure-skip-tls-verify"

  if [ -n "$clustername" ]; then
    cmd="$cmd --kubeconfig=${TMPDIR}/${clustername}"
  fi

  cat <<EOF | $cmd apply -f -
apiVersion: console.openshift.io/v1
kind: ConsoleNotification
metadata:
  name: my-banner
spec:
  text: $bannertext
  location: BannerTop
EOF
}

set -e

apply_banner "Hub Cluster"
for clustername in ${CLUSTER_NAMES[@]}; do
  apply_banner "$clustername" "$clustername"
done

rm -rf $TMPDIR
